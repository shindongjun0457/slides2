<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drive ìŠ¬ë¼ì´ë“œì‡¼ (ê³µê°œ ì „ìš© / slides2)</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#bbb; }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;overflow:hidden}
    .app{height:100%;display:grid;grid-template-rows:auto 1fr auto;transition:all .3s ease}
    .app.compact{grid-template-rows:0 1fr 0}
    header,footer{display:flex;align-items:center;gap:.75rem;padding:.6rem .9rem;transition:all .3s ease;overflow:hidden}
    header{justify-content:space-between;background:rgba(255,255,255,.06)}
    footer{justify-content:center;background:rgba(255,255,255,.04)}
    header.hidden-ui,footer.hidden-ui{opacity:0;pointer-events:none;height:0;padding:0;margin:0;border:0}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:var(--fg);padding:.5rem .8rem;border-radius:999px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:var(--fg)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{font-size:.9rem;color:var(--muted)}
    .spacer{flex:1}
    .viewer{position:relative;height:100%;width:100%;overflow:hidden;background:var(--bg)}
    .viewer img{
      position:absolute;top:50%;left:50%;
      max-width:100%;max-height:100%;
      transform:translate(-50%,-50%);
      object-fit:contain;background:var(--bg);
      opacity:0;transition:opacity 1s ease;
    }
    .viewer img.visible{opacity:1}
    .counter{position:absolute;bottom:10px;right:20px;background:rgba(0,0,0,.5);padding:4px 8px;border-radius:6px;font-size:.9rem}
  </style>
</head>
<body>
  <div class="app">
    <header id="header">
      <div style="display:flex;align-items:center;gap:.6rem">
        <strong>ê³µê°œ ìŠ¬ë¼ì´ë“œì‡¼</strong>
        <span class="status" id="status">ê³µê°œ í´ë”ì—ì„œ ë¡œë“œ ì¤€ë¹„â€¦</span>
      </div>
      <div class="spacer"></div>
      <!-- ë¡œê·¸ì¸ UI ì—†ìŒ -->
    </header>

    <main class="viewer">
      <img id="slide" alt="ì‚¬ì§„" referrerpolicy="no-referrer" />
      <div class="counter" id="counter">0 / 0</div>
    </main>

    <footer id="footer">
      <button class="btn" id="prevBtn">â—€ ì´ì „</button>
      <button class="btn" id="playPauseBtn">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn" id="nextBtn">ë‹¤ìŒ â–¶</button>
      <button class="btn" id="reloadBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <span class="spacer"></span>
      <label class="status">ì „í™˜ ê°„ê²©
        <select id="intervalSelect">
          <option value="5000">5ì´ˆ</option>
          <option value="10000" selected>10ì´ˆ</option>
          <option value="15000">15ì´ˆ</option>
          <option value="20000">20ì´ˆ</option>
          <option value="25000">25ì´ˆ</option>
          <option value="30000">30ì´ˆ</option>
        </select>
      </label>
    </footer>
  </div>

  <script>
    /* ================================
       ğŸ”§ í™˜ê²½ì„¤ì • (slides2 ì „ìš©)
    =================================*/
    const GOOGLE_API_KEY   = "AIzaSyB5fxju30j5haSlHux8TrhqzG5ui_-Ljho";
    const PUBLIC_FOLDER_ID = "1pfTBWOTpvoPazLsqz2scVdKQdKJP4Ngz";

    /* ================================
       ìƒìˆ˜ / ìƒíƒœ
    =================================*/
    const API_BASE = "https://www.googleapis.com/drive/v3";
    let files = [], index = 0, timer = null, intervalMs = 10000, playing = true;

    const statusEl   = document.getElementById('status');
    const slideEl    = document.getElementById('slide');
    const counterEl  = document.getElementById('counter');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const reloadBtn  = document.getElementById('reloadBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const intervalSelect = document.getElementById('intervalSelect');
    const headerEl   = document.getElementById('header');
    const footerEl   = document.getElementById('footer');
    const appEl      = document.querySelector('.app');

    function toast(msg){ statusEl.textContent = msg; }

    window.onload = async () => {
      bindUI();
      try{
        await loadAllImagesPublic();
        startSlideshow();
      }catch(e){
        console.error(e);
        toast('ê³µê°œ í´ë” ë¡œë“œ ì‹¤íŒ¨');
      }
      document.addEventListener('fullscreenchange', () => {
        document.body.style.overflow = "hidden";
        forceRelayout();
      });
      window.addEventListener('resize', forceRelayout);
    };

    function bindUI(){
      prevBtn.onclick = () => { prev(); restartTimer(); };
      nextBtn.onclick = () => { next(); restartTimer(); };
      reloadBtn.onclick = async () => {
        const keep = index;
        await loadAllImagesPublic();
        index = Math.min(keep, Math.max(0, files.length-1));
        show(index);
        if (playing) restartTimer();
        toast('ìµœì‹  ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
      };
      playPauseBtn.onclick = togglePlay;
      intervalSelect.onchange = () => {
        intervalMs = parseInt(intervalSelect.value,10);
        if (playing) restartTimer();
      };

      // ë‹¨ì¶•í‚¤
      let uiHidden=false;
      window.addEventListener('keydown',(e)=>{
        if(e.key==='ArrowLeft'){prev();restartTimer();}
        if(e.key==='ArrowRight'){next();restartTimer();}
        if(e.key===' '){e.preventDefault();togglePlay();}
        if(e.key.toLowerCase()==='r') reloadBtn.click();
        if(e.key.toLowerCase()==='h'){
          uiHidden=!uiHidden;
          headerEl.classList.toggle('hidden-ui', uiHidden);
          footerEl.classList.toggle('hidden-ui', uiHidden);
          appEl.classList.toggle('compact', uiHidden);
          forceRelayout();
        }
        if(e.key.toLowerCase()==='f') toggleFullScreen();
      });
    }

    /* ================================
       ë°ì´í„° ë¡œë“œ (ê³µê°œ ì „ìš©)
    =================================*/
    async function loadAllImagesPublic(){
      files = []; let pageToken;
      const q = encodeURIComponent(`'${PUBLIC_FOLDER_ID}' in parents and mimeType contains 'image/' and trashed=false`);
      const fields = encodeURIComponent('nextPageToken, files(id,name,mimeType,modifiedTime)');
      do{
        const url = `${API_BASE}/files?q=${q}&fields=${fields}&orderBy=modifiedTime&pageSize=1000&key=${GOOGLE_API_KEY}${pageToken?`&pageToken=${pageToken}`:''}&supportsAllDrives=true&includeItemsFromAllDrives=true`;
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data));
        if (Array.isArray(data.files)) files.push(...data.files);
        pageToken = data.nextPageToken;
      }while(pageToken);
      toast(`(ê³µê°œ) ${files.length}ì¥ ë¡œë“œ ì™„ë£Œ`);
      index = Math.min(index, Math.max(0, files.length-1));
      show(index);
    }

    /* ================================
       ë·°ì–´ ë¡œì§ (CORS í”„ë¦¬)
       - ì´ë¯¸ì§€ ë¡œë”©ì„ Driveì˜ ê³µê°œ URL í¬ë§·ìœ¼ë¡œ ì „í™˜
       - ì‹¤íŒ¨ ì‹œ ì¸ë„¤ì¼ URLë¡œ í´ë°±
    =================================*/
    function show(i){
      if (files.length===0){
        slideEl.removeAttribute('src'); counterEl.textContent='0 / 0'; return;
      }
      index = (i + files.length) % files.length;
      const file = files[index];

      // ê³µê°œ ì´ë¯¸ì§€ìš© URL (CORS OK)
      const viewUrl = `https://drive.google.com/uc?export=view&id=${file.id}`;
      // í˜¹ì‹œ viewê°€ ë§‰íˆë©´ ì¸ë„¤ì¼(ê³ í•´ìƒë„ ì‹œë„)ë¡œ í´ë°±
      const thumbUrl = `https://drive.google.com/thumbnail?id=${file.id}&sz=w2000`;

      slideEl.classList.remove('visible');

      // ë¨¼ì € viewUrl ì‹œë„
      slideEl.onerror = () => {
        // view ì‹¤íŒ¨ ì‹œ í•œ ë²ˆë§Œ ì¸ë„¤ì¼ë¡œ êµì²´
        if (slideEl.dataset.fallback !== "1") {
          slideEl.dataset.fallback = "1";
          slideEl.src = thumbUrl;
        } else {
          // ì¸ë„¤ì¼ê¹Œì§€ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ í‘œì‹œ
          toast('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
        }
      };

      slideEl.onload = () => {
        slideEl.classList.add('visible');
        slideEl.dataset.fallback = "0";
      };

      slideEl.src = viewUrl;
      counterEl.textContent = `${index+1} / ${files.length}`;
    }

    function next(){ if(files.length){ show(index+1); } }
    function prev(){ if(files.length){ show(index-1); } }

    function startSlideshow(){ playing=true; playPauseBtn.textContent='â¸ ì¼ì‹œì •ì§€'; restartTimer(); }
    function stopSlideshow(){ playing=false; playPauseBtn.textContent='â–¶ ì¬ìƒ'; if(timer){clearInterval(timer); timer=null;} }
    function restartTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ next(); }, intervalMs); }
    function togglePlay(){ if(playing) stopSlideshow(); else startSlideshow(); }

    function toggleFullScreen(){
      if(!document.fullscreenElement){
        document.documentElement.requestFullscreen();
        document.body.style.overflow = "hidden";
      } else if(document.exitFullscreen){
        document.exitFullscreen();
        document.body.style.overflow = "hidden";
      }
      forceRelayout();
    }

    function forceRelayout(){
      slideEl.style.willChange = 'transform';
      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{
        slideEl.style.willChange = 'auto';
      });});
    }
  </script>
</body>
</html>
